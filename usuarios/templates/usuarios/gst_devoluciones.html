{% extends 'usuarios/baseU.html' %}

{% block styles %}
<style>
    .contenedor-admin-devoluciones {
        padding: 2rem;
        max-width: 1700px;
        margin: 0 auto;
        margin-left: 40px;
    }

    h2 {
        margin-bottom: 2rem;
        font-size: 2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: 570px;
        color: black;
    }

    .filtros {
        background-color: #fff;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .filtro-grupo {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
    }

    .filtro-grupo label {
        font-weight: bold;
        color: #555;
        font-size: 0.9rem;
    }

    .filtro-grupo select,
    .filtro-grupo input {
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }

    .btn-filtrar {
        padding: 10px 20px;
        background-color: #E5BE01;
        color: #292929;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        align-self: flex-end;
    }

    .btn-filtrar:hover {
        background-color: #d4ad00;
    }

    .tabla-devoluciones {
        background-color: #fff;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background-color: #E5BE01;
        color: white;
    }

    thead th {
        padding: 1rem;
        text-align: left;
        font-weight: bold;
    }

    tbody tr {
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }

    tbody tr:hover {
        background-color: #f9f9f9;
    }

    tbody td {
        padding: 1rem;
    }

    .estado-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.85rem;
        text-transform: uppercase;
    }

    .estado-pendiente {
        background-color: #FFA500;
        color: white;
    }

    .estado-aprobada {
        background-color: #4CAF50;
        color: white;
    }

    .estado-rechazada {
        background-color: #f44336;
        color: white;
    }

    .botones-accion {
        display: flex;
        gap: 0.5rem;
    }

    .btn-ver,
    .btn-aprobar,
    .btn-rechazar {
        padding: 6px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: bold;
        transition: all 0.2s;
    }

    .btn-ver {
        background-color: #2196F3;
        color: white;
    }

    .btn-ver:hover {
        background-color: #0b7dda;
    }

    .btn-aprobar {
        background-color: #4CAF50;
        color: white;
    }

    .btn-aprobar:hover {
        background-color: #45a049;
    }

    .btn-rechazar {
        background-color: #f44336;
        color: white;
    }

    .btn-rechazar:hover {
        background-color: #da190b;
    }

    .no-devoluciones {
        text-align: center;
        padding: 3rem;
        color: #999;
    }

    .no-devoluciones i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #ddd;
    }

    .modal-overlay {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: 15px;
        max-width: 800px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
    }

    .modal-header h3 {
        color: #2c3e50;
        font-size: 1.5rem;
    }

    .btn-cerrar-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
        transition: color 0.2s;
    }

    .btn-cerrar-modal:hover {
        color: #f44336;
    }

    .detalle-seccion {
        margin-bottom: 1.5rem;
    }

    .detalle-seccion h4 {
        color: #E5BE01;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .detalle-info {
        background-color: #f9f9f9;
        padding: 1rem;
        border-radius: 8px;
        line-height: 1.8;
    }

    .detalle-info p {
        margin: 0.5rem 0;
    }

    .detalle-info strong {
        color: #2c3e50;
    }

    /* üëá AJUSTES PARA HACER LAS IM√ÅGENES M√ÅS PEQUE√ëAS */
    .galeria-fotos {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 180px)); /* üëà Reducido de 200px */
        gap: 1rem;
        margin-top: 1rem;
        justify-content: center; /* üëà Centrar las im√°genes */
    }

    .foto-item-modal {
        position: relative;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #E5BE01;
        cursor: pointer;
        transition: transform 0.2s;
        max-width: 180px; /* üëà Tama√±o m√°ximo */
        max-height: 180px; /* üëà Tama√±o m√°ximo */
    }

    .foto-item-modal:hover {
        transform: scale(1.05);
    }

    .foto-item-modal img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .sin-fotos {
        text-align: center;
        color: #999;
        padding: 2rem;
        background-color: #f9f9f9;
        border-radius: 8px;
    }

    .sin-fotos i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #ddd;
    }

    .modal-imagen {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.95);
        justify-content: center;
        align-items: center;
    }

    .modal-imagen.active {
        display: flex;
    }

    .modal-imagen img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 10px;
    }

    .btn-cerrar-imagen {
        position: absolute;
        top: 20px;
        right: 40px;
        font-size: 3rem;
        color: white;
        cursor: pointer;
        background: none;
        border: none;
        transition: transform 0.2s;
    }

    .btn-cerrar-imagen:hover {
        transform: scale(1.2);
    }

    .acciones-modal {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid #eee;
    }

    @media (max-width: 768px) {
        .contenedor-admin-devoluciones {
            margin-left: 0;
        }

        .tabla-devoluciones {
            overflow-x: auto;
        }

        .filtros {
            flex-direction: column;
            align-items: stretch;
        }

        .btn-filtrar {
            align-self: stretch;
        }

        /* üëá Im√°genes a√∫n m√°s peque√±as en m√≥vil */
        .galeria-fotos {
            grid-template-columns: repeat(auto-fit, minmax(120px, 150px));
        }

        .foto-item-modal {
            max-width: 150px;
            max-height: 150px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="contenedor-admin-devoluciones">
    <h2>
        Gesti√≥n de Devoluciones
    </h2>

    <form method="GET" class="filtros">
        <div class="filtro-grupo">
            <label>Estado:</label>
            <select name="estado">
                <option value="">Todos</option>
                <option value="Pendiente">Pendiente</option>
                <option value="Aprobada">Aprobada</option>
                <option value="Rechazada">Rechazada</option>
            </select>
        </div>

        <div class="filtro-grupo">
            <label>Desde:</label>
            <input type="date" name="fecha_desde">
        </div>

        <div class="filtro-grupo">
            <label>Hasta:</label>
            <input type="date" name="fecha_hasta">
        </div>

        <button type="submit" class="btn-filtrar">
            <i class="fa fa-filter"></i> Filtrar
        </button>
    </form>

    <div class="tabla-devoluciones">
        {% if devoluciones %}
        <table>
            <thead>
                <tr>
                    <th>#ID</th>
                    <th>Cliente</th>
                    <th>Producto</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for devolucion in devoluciones %}
                <tr>
                    <td><strong>#{{ devolucion.id }}</strong></td>
                    <td>{{ devolucion.usuario.nombre }}</td>
                    <td>{{ devolucion.producto.nombProduc }}</td>
                    <td>{{ devolucion.fecha_solicitud|date:"d/m/Y" }}</td>
                    <td>
                        <span class="estado-badge estado-{{ devolucion.estado|lower }}">
                            {{ devolucion.estado }}
                        </span>
                    </td>
                    <td>
                        <div class="botones-accion">
                            <!-- ‚úÖ Correcci√≥n: comillas alrededor del ID -->
                            <button class="btn-ver" type="button" onclick="verDetalles('{{ devolucion.id }}')">
                                <i class="fa fa-eye"></i> Ver
                            </button>

                            {% if devolucion.estado == 'Pendiente' %}
                            <form method="POST" action="{% url 'usuarios:aprobar_devolucion' devolucion.id %}"
                                style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn-aprobar">
                                    <i class="fa fa-check"></i> Aprobar
                                </button>
                            </form>
                            <form method="POST" action="{% url 'usuarios:rechazar_devolucion' devolucion.id %}"
                                style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn-rechazar">
                                    <i class="fa fa-times"></i> Rechazar
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="no-devoluciones">
            <i class="fa fa-inbox"></i>
            <p>No hay devoluciones registradas</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- MODALES -->
<div class="modal-overlay" id="modalDetalles">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fa fa-info-circle"></i> Detalles de la Devoluci√≥n</h3>
            <button class="btn-cerrar-modal" onclick="cerrarModal()">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div id="contenidoModal"></div>
    </div>
</div>

<div class="modal-imagen" id="modalImagen">
    <button class="btn-cerrar-imagen" onclick="cerrarImagen()">
        <i class="fa fa-times"></i>
    </button>
    <img id="imagenGrande" src="" alt="Foto del producto">
</div>

<script id="datosJson" type="application/json">
    {{ devoluciones_json|safe }}
</script>
{% endblock %}

{% block scripts %}
<script>
    var devolucionesData = [];

    try {
        devolucionesData = JSON.parse(document.getElementById('datosJson').textContent || '[]');
    } catch (e) {
        console.error("Error al parsear devoluciones_json:", e);
    }

    function verDetalles(id) {
        id = parseInt(id); // ‚úÖ asegura que sea n√∫mero
        var devolucion = devolucionesData.find(function (d) { return d.id === id; });
        if (!devolucion) return;

        var fotosHTML = '';
        if (devolucion.fotos && devolucion.fotos.length > 0) {
            fotosHTML = '<div class="galeria-fotos">';
            for (var i = 0; i < devolucion.fotos.length; i++) {
                var foto = devolucion.fotos[i];
                fotosHTML += '<div class="foto-item-modal" onclick="verImagenGrande(\'' + foto + '\')">';
                fotosHTML += '<img src="' + foto + '" alt="Foto del producto">';
                fotosHTML += '</div>';
            }
            fotosHTML += '</div>';
        } else {
            fotosHTML = '<div class="sin-fotos"><i class="fa fa-image"></i><p>No se adjuntaron fotos</p></div>';
        }

        var accionesHTML = '';
        if (devolucion.estado === 'Pendiente') {
            accionesHTML = '<div class="acciones-modal">';
            accionesHTML += '<form method="POST" action="/usuarios/aprobar-devolucion/' + devolucion.id + '/" style="display: inline;">';
            accionesHTML += '<input type="hidden" name="csrfmiddlewaretoken" value="' + getCookie('csrftoken') + '">';
            accionesHTML += '<button type="submit" class="btn-aprobar" style="padding: 12px 24px; font-size: 1rem;">';
            accionesHTML += '<i class="fa fa-check"></i> Aprobar Devoluci√≥n</button></form>';
            accionesHTML += '<form method="POST" action="/usuarios/rechazar-devolucion/' + devolucion.id + '/" style="display: inline;">';
            accionesHTML += '<input type="hidden" name="csrfmiddlewaretoken" value="' + getCookie('csrftoken') + '">';
            accionesHTML += '<button type="submit" class="btn-rechazar" style="padding: 12px 24px; font-size: 1rem;">';
            accionesHTML += '<i class="fa fa-times"></i> Rechazar Devoluci√≥n</button></form>';
            accionesHTML += '</div>';
        }

        var contenido = `
            <div class="detalle-seccion">
                <h4><i class="fa fa-user"></i> Informaci√≥n del Cliente</h4>
                <div class="detalle-info">
                    <p><strong>Nombre:</strong> ${devolucion.usuario_nombre}</p>
                    <p><strong>Email:</strong> ${devolucion.usuario_email}</p>
                </div>
            </div>

            <div class="detalle-seccion">
                <h4><i class="fa fa-box"></i> Informaci√≥n del Producto</h4>
                <div class="detalle-info">
                    <p><strong>Producto:</strong> ${devolucion.producto_nombre}</p>
                    <p><strong>Pedido:</strong> #${devolucion.pedido_id}</p>
                    <p><strong>Fecha de solicitud:</strong> ${devolucion.fecha}</p>
                </div>
            </div>

            <div class="detalle-seccion">
                <h4><i class="fa fa-comment-dots"></i> Motivo de la Devoluci√≥n</h4>
                <div class="detalle-info">
                    <p>${devolucion.motivo}</p>
                </div>
            </div>

            <div class="detalle-seccion">
                <h4><i class="fa fa-camera"></i> Fotos del Producto</h4>
                ${fotosHTML}
            </div>

            ${accionesHTML}
        `;

        document.getElementById('contenidoModal').innerHTML = contenido;
        document.getElementById('modalDetalles').classList.add('active');
    }

    function cerrarModal() {
        document.getElementById('modalDetalles').classList.remove('active');
    }

    function verImagenGrande(src) {
        document.getElementById('imagenGrande').src = src;
        document.getElementById('modalImagen').classList.add('active');
    }

    function cerrarImagen() {
        document.getElementById('modalImagen').classList.remove('active');
    }

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}