{% extends 'usuarios/baseU.html' %}
{% load static %}
{% block styles %}
<link rel="stylesheet" href="{% static 'usuarios/css/devoluciones-usuarios.css' %}" />
{% endblock %}

{% block page_id %}devoluciones{% endblock %}

{% block content %}

<div class="contenedor-admin-devoluciones">
    <h2>
        Gesti贸n de Devoluciones
    </h2>

    <form method="GET" class="filtros-devoluciones">
        <div class="filtro-grupo">
            <label>Estado:</label>
            <select name="estado">
                <option value="">Todos</option>
                <option value="Pendiente">Pendiente</option>
                <option value="Aprobada">Aprobada</option>
                <option value="Rechazada">Rechazada</option>
            </select>
        </div>

        <div class="filtro-grupo">
            <label>Desde:</label>
            <input type="date" name="fecha_desde">
        </div>

        <div class="filtro-grupo">
            <label>Hasta:</label>
            <input type="date" name="fecha_hasta">
        </div>

        <button type="submit" class="btn-filtrar-devoluciones">
            <i class="fa fa-filter"></i> Filtrar
        </button>
    </form>

    <div class="tabla-devoluciones">
        {% if devoluciones %}
        <table>
            <thead>
                <tr>
                    <th>#ID</th>
                    <th>Cliente</th>
                    <th>Producto</th>
                    <th>Lote</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for devolucion in devoluciones %}
                <!--  ID agregado para eliminar la fila con AJAX -->
                <tr id="devolucion-{{ devolucion.id }}">
                    <td><strong>#{{ devolucion.id }}</strong></td>
                    <td>{{ devolucion.usuario.nombre }}</td>
                    <td>{{ devolucion.producto.nombProduc }}</td>
                    <td>
                        {% if devolucion.lote %}
                        {{ devolucion.lote.codigo_lote }}
                        {% else %}
                        SIN LOTE
                        {% endif %}
                    </td>


                    <td>{{ devolucion.fecha_solicitud|date:"d/m/Y" }}</td>
                    <td>
                        <span class="estado-badge estado-{{ devolucion.estado|lower }}">
                            {{ devolucion.estado }}
                        </span>
                    </td>
                    <td>
                        <div class="botones-accion">

                            <!-- Ver detalles -->
                            <button class="btn-ver" type="button" onclick="verDetalles('{{ devolucion.id }}')">
                                <i class="fa fa-eye"></i> Ver
                            </button>

                            {% if devolucion.estado == 'Pendiente' %}
                            <!--  Bot贸n AJAX de APROBAR -->
                            <button type="button" class="btn-aprobar" data-action="aprobar"
                                data-id="{{ devolucion.id }}">
                                <i class="fa fa-check"></i> Aprobar
                            </button>

                            <!--  Bot贸n AJAX de RECHAZAR -->
                            <button type="button" class="btn-rechazar" data-action="rechazar"
                                data-id="{{ devolucion.id }}">
                                <i class="fa fa-times"></i> Rechazar
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="no-devoluciones">
            <i class="fa fa-inbox"></i>
            <p>No hay devoluciones registradas</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- MODALES -->
<div class="modal-overlay" id="modalDetalles">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fa fa-info-circle"></i> Detalles de la Devoluci贸n</h3>
            <button class="btn-cerrar-modal" onclick="cerrarModal()">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div id="contenidoModal"></div>
    </div>
</div>

<div class="modal-imagen" id="modalImagen">
    <button class="btn-cerrar-imagen" onclick="cerrarImagen()">
        <i class="fa fa-times"></i>
    </button>
    <img id="imagenGrande" src="" alt="Foto del producto">
</div>

<script id="datosJson" type="application/json">
    {{ devoluciones_json|safe }}
</script>

{% endblock %}

{% block scripts %}
<script src="{% static 'usuarios/js/devoluciones-usuarios.js' %}"></script>
{% endblock %}