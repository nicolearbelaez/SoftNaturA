{% extends 'usuarios/baseU.html' %}
{% block title %}GestiÃ³n de calificaciones{% endblock %}

{% load humanize %}
{% block styles %}
<style>
  body {
    background-color: #f5f5f5;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .container {
    max-width: 1700px;
    margin: 0 auto;
    padding: 20px;
    margin-left: 20px;
  }

  .header-section {
    margin-bottom: 30px;
  }

  h1 {
    margin: 10px 0 22px 0;
    color: #292929;
    text-align: center;
    margin-top: 50px;
  }

  .filtros {
    background: transparent;
    padding: 20px 0;
    margin-bottom: 20px;
    border-radius: 0;
    box-shadow: none;
    border: none !important;
    outline: none !important;
    width: 100%;
    max-width: 1200px;
  }

  .search-container {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border: 1px solid #e0e0e0;
    margin-bottom: 20px;
  }

  .search-input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 25px;
    font-size: 14px;
    background-color: #f8f9fa;
    transition: all 0.2s ease;
    box-sizing: border-box;
  }

  .search-input:focus {
    outline: none;
    border-color: #F2C641;
    box-shadow: 0 0 0 3px rgba(242, 198, 65, 0.1);
    background-color: white;
  }

  .btn-export {
    background-color: #E5BE01;
    color: #292929;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    font-size: 17px;
    transition: all 0.3s ease;
    display: block;
    margin: 0 0 20px auto;
  }

  .btn-export:hover {
    background-color: #F27405;
  }

  .table-container {
    background: white;
    border-radius: 8px;
    overflow-x: auto;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border: 1px solid #e0e0e0;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    min-width: 800px;
  }

  thead {
    background: white;
  }

  th {
    text-align: center;
    padding: 15px 12px;
    color: #333;
    text-transform: uppercase;
    font-size: 16px;
    white-space: nowrap;
  }

  td {
    padding: 13px;
    border-bottom: 1px solid #f0f0f0;
    color: #555;
    font-size: 15px;
    text-align: center;
  }

  tbody tr {
    transition: background-color 0.2s ease;
  }

  tbody tr:nth-child(even) {
    background-color: #fafafa;
  }

  tbody tr:hover {
    background-color: #f8f9fa;
  }

  .no-data {
    text-align: center;
    padding: 40px;
    font-style: italic;
    color: #999;
    font-size: 16px;
  }

  .btn-aceptar,
  .btn-rechazar {
    display: inline-block;
    padding: 6px 12px;
    margin: 2px;
    border-radius: 8px;
    text-decoration: none;
    font-size: 15px;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    white-space: nowrap;
  }

  .btn-aceptar {
    background: #E5BE01;
    color: #292929;
    font-weight: bold;
  }

  .btn-aceptar:hover {
    background: #F27405;
    transform: translateY(-1px);
  }

  .btn-rechazar {
    background: #005E27;
    color: white;
    font-weight: bold;
  }

  .btn-rechazar:hover {
    background: #6e823e;
    transform: translateY(-1px);
  }

  .estado-aprobado {
    color: #005E27;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .search-stats {
    margin-top: 10px;
    font-size: 14px;
    color: #666;
    text-align: center;
  }

  .pagination {
    display: flex;
    justify-content: center;
    margin: 20px 0;
    flex-wrap: wrap;
    gap: 5px;
  }

  /* ========================= */
  /* ðŸ“± RESPONSIVIDAD         */
  /* ========================= */

  /* Laptops y pantallas grandes */
  @media (max-width: 1400px) {
    .container {
      max-width: 1200px;
      padding: 20px;
      margin-left: 40px;
    }
  }

  /* Tablets horizontales */
  @media (max-width: 1200px) {
    .container {
      padding: 20px 15px;
    }

    h1 {
      font-size: 24px;
      margin-top: 30px;
    }

    .filtros {
      max-width: 100%;
    }
  }

  /* Tablets verticales */
  @media (max-width: 992px) {
    .container {
      padding: 15px;
      margin-left: 100px;
    }

    h1 {
      font-size: 22px;
      margin-top: 20px;
    }

    .search-container {
      padding: 15px;
    }

    .btn-export {
      width: auto;
      min-width: 150px;
    }

    table {
      font-size: 14px;
      min-width: 700px;
    }

    th,
    td {
      padding: 10px 8px;
      font-size: 14px;
    }

    th {
      font-size: 13px;
    }
  }

  /* MÃ³viles grandes */
  @media (max-width: 768px) {
    body {
      font-size: 14px;
    }


    .container {
      padding: 10px;
      margin-left: 150px;
    }

    h1 {
      font-size: 25px;
      margin-left: 150px;
    }

    .search-container {
      padding: 12px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
    }

    .search-input {
      font-size: 14px;
      padding: 10px 12px;
    }

    .btn-export {
      width: 40%;
      padding: 10px;
      font-size: 15px;
      margin-bottom: 15px;
    }

    .table-container {
      border-radius: 6px;
      margin: 0 -5px;
    }

    table {
      min-width: 650px;
      font-size: 13px;
    }

    th,
    td {
      padding: 8px 6px;
      font-size: 13px;
    }

    th {
      font-size: 12px;
    }

    .btn-aceptar,
    .btn-rechazar {
      font-size: 12px;
      padding: 5px 10px;
      margin: 1px;
    }

    .estado-aprobado {
      font-size: 11px;
    }
  }

  /* MÃ³viles pequeÃ±os */
  @media (max-width: 480px) {
    .container {
      padding: 8px;
      margin-left: 86px;
    }

    h1 {
      font-size: 18px;
      margin: 10px 0;
    }

    .search-container {
      padding: 10px;
    }

    .search-input {
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 20px;
    }

    .btn-export {
      width: 50%;
      padding: 10px;
      font-size: 15px;
      margin-bottom: 15px;
      margin-left: 25px;
    }

    .table-container {
      margin: 0 -3px;
    }

    table {
      min-width: 600px;
      font-size: 12px;
    }

    th,
    td {
      padding: 6px 4px;
      font-size: 12px;
    }

    th {
      font-size: 11px;
      padding: 8px 4px;
    }

    .btn-aceptar,
    .btn-rechazar {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .estado-aprobado {
      font-size: 10px;
    }

    .no-data {
      padding: 30px 10px;
      font-size: 14px;
    }
  }

  /* MÃ³viles muy pequeÃ±os */
  @media (max-width: 360px) {
    h1 {
      font-size: 16px;
    }

    table {
      min-width: 550px;
    }

    .btn-export {
      font-size: 14px;
      padding: 9px;
    }
  }
</style>
{% endblock %}

{% block content %}
<h1>Lista de calificaciones</h1>

<div class="container">

  <!-- Buscador -->
  <div class="search-container">
    <button class="btn-export" id="btnExportar">
      <i class="fa fa-file-excel"></i> Exportar a Excel
    </button>
    <input type="text" class="search-input" id="searchInput" placeholder="Buscar por usuario, comentario...">
    <div class="search-stats" id="searchStats"></div>
  </div>

  <div class="table-container">
    <table id="calificacionesTable">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Servicio</th>
          <th>Productos</th>
          <th>Comentario</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for c in calificaciones %}
        <tr
          data-search-text="{{ c.usuario.nombre|lower }} {{ c.puntuacion_servicio }} {{ c.puntuacion_productos }} {{ c.comentario|lower }} {{ c.fecha_creacion|date:'Y-m-d' }}">
          <td>{{ c.usuario.nombre }}</td>
          <td>{{ c.puntuacion_servicio }}</td>
          <td>{{ c.puntuacion_productos }}</td>
          <td>{{ c.comentario }}</td>
          <td>{{ c.fecha_creacion|date:"Y-m-d H:i" }}</td>
          <td>
            {% if not c.aprobado %}
            <a href="{% url 'usuarios:aprobar_comentario' c.id %}" class="btn-aceptar">Aprobar</a>
            <a href="{% url 'usuarios:rechazar_comentario' c.id %}" class="btn-rechazar">Rechazar</a>
            {% else %}
            <span class="estado-aprobado">âœ“ Aprobado</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="no-data">No hay calificaciones disponibles</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="pagination">
      {% if page_obj.has_previous %}
      <a href="?page=1">&laquo; Primera</a>
      <a href="?page={{ page_obj.previous_page_number }}">Anterior</a>
      {% endif %}

      <span class="current">
        PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
      </span>

      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}">Siguiente</a>
      <a href="?page={{ page_obj.paginator.num_pages }}">Ãšltima &raquo;</a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');
    const searchStats = document.getElementById('searchStats');
    const tbody = document.querySelector('#calificacionesTable tbody');
    const rows = tbody.querySelectorAll('tr[data-search-text]');
    const totalRows = rows.length;

    function actualizarEstadisticas() {
      const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none').length;

      if (searchInput.value.trim() === '') {
        searchStats.textContent = `Mostrando ${totalRows} calificaciÃ³n${totalRows !== 1 ? 'es' : ''}`;
      } else {
        searchStats.textContent = `Encontradas ${visibleRows} de ${totalRows} calificaciÃ³n${totalRows !== 1 ? 'es' : ''}`;
      }
    }

    if (searchInput) {
      // Mostrar estadÃ­sticas iniciales
      actualizarEstadisticas();

      searchInput.addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase().trim();

        rows.forEach(row => {
          const searchText = row.dataset.searchText || '';

          if (searchTerm === '' || searchText.includes(searchTerm)) {
            row.style.display = '';
          } else {
            row.style.display = 'none';
          }
        });

        actualizarEstadisticas();
      });
    }
  });
  document.getElementById("btnExportar").addEventListener("click", function () {
    window.location.href = window.location.pathname + "?exportar=excel";
  });

</script>
{% endblock %}