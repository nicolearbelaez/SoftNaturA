{% extends 'usuarios/baseU.html' %}
{% load static %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'usuarios/css/devoluciones-usuarios.css' %}" />
{% endblock %}

{% block content %}
<div data-page="gst-usuarios"></div>


<h1>Lista de usuarios</h1>
<div class="contenedor">
  <div class="search-container">
    <div class="acciones-superiores">
      <button class="agregar" onclick="abrirModalAgregar()">Agregar Usuario</button>
      <a class="btn-export" id="btnExportar" href="{% url 'usuarios:exportar_usuarios_excel' %}">Exportar Excel</a>

    </div>
    <input type="text" class="search-input" id="searchInput" placeholder="Buscar usuario...">
    <p id="searchStatsUsuarios" class="search-stats"></p>
  </div>

  <table class="tabla-usuarios">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Teléfono</th>
        <th>Rol</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="usuariosTable">
      {% for usuario in usuarios %}
      <tr class="{% if not usuario.is_active %}fila-inactiva{% endif %}" data-id="{{ usuario.id }}"
        data-search-text="{{ usuario.nombre|lower }} {{ usuario.email|lower }} {{ usuario.phone_number }} {{ usuario.rol|lower }}">
        <td>{{ usuario.id }}</td>
        <td>{{ usuario.nombre }}</td>
        <td>{{ usuario.email }}</td>
        <td>{{ usuario.phone_number }}</td>
        <td>{{ usuario.rol }}</td>
        <td class="acciones">
          {% if usuario.is_active %}
          <button class="editar" data-id="{{ usuario.id }}" data-nombre="{{ usuario.nombre }}"
            data-email="{{ usuario.email }}" data-telefono="{{ usuario.phone_number }}" data-rol="{{ usuario.rol }}">
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
          <a href="{% url 'usuarios:cambiar_estado_usuario' usuario.id %}">
            <button class="inactivar"><i class="fa-solid fa-user-slash"></i></button>
          </a>
          {% else %}
          <button class="editar" disabled>
            <i class="fa-solid fa-pen-to-square"></i>
          </button>
          <a href="{% url 'usuarios:cambiar_estado_usuario' usuario.id %}">
            <button class="activar"><i class="fa-solid fa-user-check"></i></button>
          </a>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" style="text-align: center; padding: 20px">No hay usuarios registrados.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="pagination">
    {% if page_obj.has_previous %}
    <a href="?page=1">&laquo; Primero</a>
    <a href="?page={{ page_obj.previous_page_number }}">Anterior</a>
    {% endif %}

    <span>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}">Siguiente</a>
    <a href="?page={{ page_obj.paginator.num_pages }}">Último &raquo;</a>
    {% endif %}
  </div>
</div>

<div id="modal-overlay" class="modal-overlay" onclick="cerrarTodosLosModales()"></div>

<div id="modal-agregar" class="modal">
  <form method="post" action="{% url 'usuarios:agregar_usuario' %}">
    {% csrf_token %}
    <h3>Agregar Usuario</h3>
    <label for="agregar-nombre">Nombre</label>
    <input id="agregar-nombre" name="nombre" type="text" required />
    <label for="agregar-email">Correo</label>
    <input id="agregar-email" name="email" type="email" required />
    <label for="agregar-password">Contraseña</label>
    <input id="agregar-password" name="password" type="password" required />
    <label for="agregar-telefono">Teléfono</label>
    <input id="agregar-telefono" name="phone_number" type="text" required />
    <label for="agregar-rol">Rol</label>
    <select id="agregar-rol" name="rol" required>
      <option value="admin">Administrador</option>
      <option value="cliente" selected>Cliente</option>
    </select>
    <div class="botones-modal">
      <button type="submit" class="guardar">Guardar</button>
      <button type="button" class="cancelar" onclick="cerrarModalAgregar()">Cancelar</button>
    </div>
  </form>
</div>

<div id="modal-editar" class="modal">
  <form id="form-editar" method="post">
    {% csrf_token %}
    <h3>Editar Usuario</h3>
    <input type="hidden" name="id" id="editar-id" />
    <label for="editar-nombre">Nombre</label>
    <input id="editar-nombre" name="nombre" type="text" required />
    <label for="editar-email">Correo</label>
    <input id="editar-email" name="email" type="email" required />
    <label for="editar-telefono">Teléfono</label>
    <input id="editar-telefono" name="phone_number" type="text" required />
    <label for="editar-rol">Rol</label>
    <select id="editar-rol" name="rol" required>
      <option value="admin">Administrador</option>
      <option value="cliente">Cliente</option>
    </select>
    <div class="botones-modal">
      <button type="submit" class="guardar">Guardar</button>
      <button type="button" class="cancelar" onclick="cerrarModalEditar()">Cancelar</button>
    </div>
  </form>
</div>
{% endblock %}
{% block scripts %}
    <script src="{% static 'usuarios/js/devoluciones-usuarios.js' %}"></script>
{% endblock scripts %}
