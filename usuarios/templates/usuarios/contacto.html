{% extends 'productos/baseP.html' %}
{% load static %}
{% block content %}

<!-- Pasar variable de Django a JavaScript -->
<div style="display: none;" data-user-authenticated="{% if user.is_authenticated %}true{% else %}false{% endif %}">
</div>

<style>
  * {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .contact-container {
    display: flex;
    gap: 40px;
    margin: 80px auto;
    max-width: 1200px;
  }

  .contact-form,
  .contact-info {
    flex: 1;
    background: #fff;
    padding: 40px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .contact-form h2 {
    font-size: 26px;
    margin-bottom: 25px;
  }

  .contact-form .row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
  }

  .contact-form input,
  .contact-form textarea {
    width: 100%;
    padding: 15px;
    font-size: 16px;
    border: 1px solid #ddd;
    border-radius: 6px;
  }

  .contact-form input.invalid {
    border-color: #dc3545;
  }

  .contact-form input.valid {
    border-color: #28a745;
  }

  .contact-form input.checking {
    border-color: #ffc107;
  }

  .contact-form textarea {
    height: 150px;
    resize: none;
  }

  .email-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 5px;
    font-size: 14px;
  }

  .email-status .spinner {
    border: 2px solid #f3f3f3;
    border-top: 2px solid #ffc107;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .email-status.checking {
    color: #856404;
  }

  .email-status.valid {
    color: #28a745;
  }

  .email-status.invalid {
    color: #dc3545;
  }

  .error-message {
    color: #dc3545;
    font-size: 14px;
    margin-top: 5px;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .btn-enviar {
    margin: 20px auto;
    display: block;
    background: #FFC107;
    color: #fff;
    border: none;
    padding: 14px 28px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    width: 200px;
    font-size: 16px;
  }

  .btn-enviar:hover {
    background: #d86600;
  }

  .btn-enviar:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  .contact-info .info-item {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    font-size: 15px;
    color: #444;
  }

  .contact-info .info-item i {
    font-size: 24px;
    color: #FFC107;
    margin-right: 12px;
  }

  .social-icons {
    margin-top: 20px;
  }

  .social-icons a {
    display: inline-block;
    margin: 5px;
    width: 40px;
    height: 40px;
    line-height: 40px;
    text-align: center;
    border-radius: 50%;
    font-size: 18px;
    background: #FFC107;
    color: #fff;
    transition: 0.3s;
  }

  .social-icons a:hover {
    background: #000;
  }

  .btn-volver {
    position: absolute;
    top: 180px;
    left: 20px;
    padding: 10px 20px;
    background-color: #FFC107;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    border: none;
    font-weight: bold;
    transition: background-color 0.3s ease;
  }

  .btn-volver:hover {
    background-color: #f17800;
  }

  .banner-nosotros {
    height: 480px;
    background-size: cover;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    text-align: center;
    position: relative;
    margin: 80px 0 40px 0;
  }

  .banner-nosotros::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
</style>

<div class="banner-nosotros" style="
    background: url('/media/uploads/products/contacto.png') no-repeat center
      center/cover;
  "></div>

<div class="contact-container">
  <div class="contact-form">
    <h2>CONTÁCTANOS</h2>
    <form id="contactForm" style="width:600px;">
      <div class="row">
        <div style="flex: 1;">
          <input type="text" id="nombre" placeholder="Nombre completo" required />
        </div>
        <div style="flex: 1;">
          <input type="email" id="correo" placeholder="Correo electrónico" required />
          <div class="email-status" id="emailStatus"></div>
        </div>
      </div>

      <input type="text" id="asunto" placeholder="Asunto" required />
      <textarea id="mensaje" placeholder="Escribe tu mensaje aquí..." rows="5" required></textarea>

      <button style="width:100px" class="btn-enviar" type="submit" id="btnEnviar">Enviar</button>
    </form>
  </div>

  <div class="contact-info">
    <h3>INFORMACIÓN DE CONTACTO</h3>
    </br>
    <div class="info-item">
      <i class="fas fa-map-marker-alt"></i>
      <p>Ibagué, Tolima - Colombia</p>
    </div>
    <div class="info-item">
      <i class="fas fa-phone"></i>
      <p>3212334148</p>
    </div>
    <div class="info-item">
      <i class="fas fa-envelope"></i>
      <p>naturistasoftnatur@outlook.com</p>
    </div>
    <div class="social-icons">
      <a href="https://web.facebook.com/profile.php?id=100057407501877" target="_blank"><i
          class="fab fa-facebook-f"></i></a>
      <a href="https://www.instagram.com/tienda_naturista_los_girasoles" target="_blank"><i
          class="fab fa-instagram"></i></a>
      <a href="https://www.tiktok.com/@tnlosgirasoles" target="_blank"><i class="fab fa-tiktok"></i></a>
      <a href="https://wa.me/573106194290" target="_blank"><i class="fab fa-whatsapp"></i></a>
    </div>
  </div>
</div>

<script>
  const numeroAdministracion = "{{ numero_admin }}";
  console.log("Número admin recibido:", numeroAdministracion);


  // Variable para verificar si el usuario está logueado
  const usuarioLogueado = document.querySelector('[data-user-authenticated]').dataset.userAuthenticated === 'true';

  // Variables globales
  let emailValido = false;
  let verificandoEmail = false;
  let timeoutVerificacion = null;

  // Obtener elementos del DOM
  const correoInput = document.getElementById('correo');
  const emailStatus = document.getElementById('emailStatus');
  const contactForm = document.getElementById('contactForm');
  const btnEnviar = document.getElementById('btnEnviar');

  // Función para validar el formato del correo electrónico
  function validarFormatoEmail(email) {
    const regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    return regex.test(email);
  }

  // Función para verificar si el correo existe realmente usando API gratuita
  async function verificarEmailExiste(email) {
    try {
      // Usar AbstractAPI (gratis hasta 100 verificaciones/mes)
      // Regístrate en: https://app.abstractapi.com/api/email-validation/tester
      const API_KEY = 'test'; // Reemplaza con tu API key gratuita

      const response = await fetch(
        `https://emailvalidation.abstractapi.com/v1/?api_key=${API_KEY}&email=${encodeURIComponent(email)}`
      );

      if (!response.ok) {
        throw new Error('Error en la API');
      }

      const data = await response.json();

      console.log('Respuesta API:', data); // Para debug

      // Verificar si es un correo desechable/temporal
      if (data.is_disposable_email && data.is_disposable_email.value === true) {
        return { valido: false, mensaje: 'No se permiten correos temporales o desechables' };
      }

      // Verificar la calidad del correo
      if (data.quality_score) {
        const score = parseFloat(data.quality_score);

        // Score menor a 0.5 es sospechoso
        if (score < 0.5) {
          return { valido: false, mensaje: 'El correo parece no ser válido' };
        }
      }

      // Verificar si el formato es válido
      if (data.is_valid_format && data.is_valid_format.value === false) {
        return { valido: false, mensaje: 'Formato de correo inválido' };
      }

      // Verificar si el dominio tiene servidores de correo
      if (data.is_mx_found && data.is_mx_found.value === false) {
        return { valido: false, mensaje: 'El dominio no puede recibir correos' };
      }

      // Verificar si el servidor SMTP está disponible
      if (data.is_smtp_valid && data.is_smtp_valid.value === false) {
        return { valido: false, mensaje: 'El servidor de correo no está disponible' };
      }

      // Verificar deliverability (capacidad de entrega)
      if (data.deliverability) {
        if (data.deliverability === 'UNDELIVERABLE') {
          return { valido: false, mensaje: 'Este correo no puede recibir mensajes' };
        }
        if (data.deliverability === 'RISKY') {
          return { valido: false, mensaje: 'El correo es de riesgo. Usa uno diferente' };
        }
      }

      // Si pasó todas las validaciones
      return { valido: true, mensaje: 'Correo verificado' };

    } catch (error) {
      console.error('Error al verificar email:', error);

      // VALIDACIÓN SIN API - Si falla la API, hacer validación local robusta
      const regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      const dominiosPopulares = [
        'gmail.com', 'hotmail.com', 'outlook.com', 'yahoo.com', 'yahoo.es',
        'live.com', 'icloud.com', 'hotmail.es', 'outlook.es'
      ];

      if (!regex.test(email)) {
        return { valido: false, mensaje: 'Formato de correo inválido' };
      }

      const partes = email.split('@');
      const usuario = partes[0];
      const dominio = partes[1]?.toLowerCase();

      // Validar longitud mínima
      if (usuario.length < 3) {
        return { valido: false, mensaje: 'El correo es demasiado corto' };
      }

      // Validar dominio conocido
      if (!dominiosPopulares.includes(dominio)) {
        return { valido: false, mensaje: 'Por favor usa Gmail, Hotmail, Outlook o Yahoo' };
      }

      // Si usa dominio popular y tiene buen formato, aceptar
      return { valido: true, mensaje: 'Correo valido' };
    }
  }

  // Función para mostrar el estado de verificación
  function mostrarEstado(tipo, mensaje) {
    emailStatus.className = `email-status ${tipo}`;

    if (tipo === 'checking') {
      emailStatus.innerHTML = '<div class="spinner"></div><span>Verificando correo...</span>';
      correoInput.classList.remove('valid', 'invalid');
      correoInput.classList.add('checking');
      btnEnviar.disabled = true;
    } else if (tipo === 'valid') {
      emailStatus.innerHTML = `<i class="fas fa-check-circle"></i><span>${mensaje}</span>`;
      correoInput.classList.remove('invalid', 'checking');
      correoInput.classList.add('valid');
      btnEnviar.disabled = false;
      emailValido = true;
    } else if (tipo === 'invalid') {
      emailStatus.innerHTML = `<i class="fas fa-times-circle"></i><span>${mensaje}</span>`;
      correoInput.classList.remove('valid', 'checking');
      correoInput.classList.add('invalid');
      btnEnviar.disabled = true;
      emailValido = false;
    } else {
      emailStatus.innerHTML = '';
      correoInput.classList.remove('valid', 'invalid', 'checking');
      btnEnviar.disabled = false;
    }
  }

  // Evento cuando el usuario escribe en el campo de correo
  correoInput.addEventListener('input', function () {
    const email = this.value.trim();

    // Si el usuario está logueado, no verificar
    if (usuarioLogueado) {
      mostrarEstado('', '');
      return;
    }

    // Limpiar el timeout anterior
    if (timeoutVerificacion) {
      clearTimeout(timeoutVerificacion);
    }

    // Si el campo está vacío
    if (!email) {
      mostrarEstado('', '');
      emailValido = false;
      return;
    }

    // Validar formato primero
    if (!validarFormatoEmail(email)) {
      mostrarEstado('invalid', 'Formato de correo inválido');
      emailValido = false;
      return;
    }

    // Esperar 1 segundo después de que el usuario termine de escribir
    timeoutVerificacion = setTimeout(async () => {
      mostrarEstado('checking', 'Verificando...');
      verificandoEmail = true;

      const resultado = await verificarEmailExiste(email);

      if (resultado.valido) {
        mostrarEstado('valid', resultado.mensaje);
      } else {
        mostrarEstado('invalid', resultado.mensaje);
      }

      verificandoEmail = false;
    }, 1000);
  });

  // Validación al enviar el formulario
  contactForm.addEventListener('submit', function (e) {
    e.preventDefault();

    const correo = correoInput.value.trim();

    // Si el usuario NO está logueado, validar el correo
    if (!usuarioLogueado) {
      // Verificar formato
      if (!validarFormatoEmail(correo)) {
        mostrarEstado('invalid', 'Por favor ingresa un correo válido');
        correoInput.focus();
        return false;
      }

      // Verificar si está en proceso de verificación
      if (verificandoEmail) {
        mostrarEstado('checking', 'Espera mientras verificamos el correo...');
        return false;
      }

      // Verificar si el email fue validado
      if (!emailValido) {
        mostrarEstado('invalid', 'Por favor usa un correo electrónico válido');
        correoInput.focus();
        return false;
      }
    }

    // Obtener los valores del formulario
    const nombre = document.getElementById('nombre').value;
    const asunto = document.getElementById('asunto').value;
    const mensaje = document.getElementById('mensaje').value;

    // Crear el mensaje para WhatsApp
    const mensajeWhatsApp = `*NUEVO MENSAJE DE CONTACTO*%0A%0A` +
      `*Nombre:* ${encodeURIComponent(nombre)}%0A` +
      `*Correo:* ${encodeURIComponent(correo)}%0A` +
      `*Asunto:* ${encodeURIComponent(asunto)}%0A%0A` +
      `*Mensaje:*%0A${encodeURIComponent(mensaje)}`;

    // Número de WhatsApp
    const numeroWhatsApp = "57" + numeroAdministracion;
    window.open(`https://wa.me/${numeroWhatsApp}?text=${mensajeWhatsApp}`, '_blank');

    // Limpiar el formulario y estados
    contactForm.reset();
    mostrarEstado('', '');
    emailValido = false;
  });
</script>

{% endblock %}