{% extends 'usuarios/baseU.html' %}
{% csrf_token %}
{% block styles %}
<style>
  body {
    background-color: #f5f5f5;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #495057;
  }

  .container {
    max-width: 1700px;
    margin: 0 auto;
    padding: 20px;
    margin-left: 30px;
  }

  h1 {
    text-align: center;
    margin: 10px 0 30px 0;
    color: #292929;
  }

  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    text-align: center;
  }

  .stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #6c757d;
    text-transform: uppercase;
  }

  .stat-card .numero {
    font-size: 32px;
    font-weight: bold;
    margin: 0;
    color: #333;
  }

  .stat-card.pendientes .numero {
    color: #E5BE01;
  }

  .stat-card.enviados .numero {
    color: #28a745;
  }

  .stat-card.entregados .numero {
    color: #007bff;
  }

  .stat-card.total .numero {
    color: #005E27;
  }

  .filtros-rapidos {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 40px;
    margin-left: 20px;
  }

  .filtros-rapidos h3 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 16px;
    font-weight: 600;
  }

  .filtros-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .filtro-btn {
    padding: 8px 16px;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 20px;
    cursor: pointer;
    font-size: 14px;
    text-decoration: none;
    color: #495057;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .filtro-btn:hover {
    background: #f8f9fa;
  }

  .filtro-btn.active {
    background: #005E27;
    color: white;
    border-color: #005E27;
  }

  .search-container {
    padding: 20px;
    margin-top: 30px;
    margin-left: -25px;
  }

  .search-input {
    width: 98%;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 25px;
    font-size: 14px;
  }

  .table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th {
    text-align: center;
    padding: 15px 12px;
    font-weight: 600;
    color: #333;
    text-transform: uppercase;
    font-size: 16px;
  }

  td {
    padding: 15px 12px;
    border-bottom: 1px solid #f0f0f0;
    text-align: center;
  }

  tbody tr:hover {
    background-color: #f8f9fa;
  }

  .btn-estado {
    padding: 6px 12px;
    margin: 2px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    color: white;
    transition: all 0.2s ease;
  }

  .btn-estado:hover {
    transform: scale(1.05);
    opacity: 0.9;
  }

  .btn-estado.pendiente {
    background: #E5BE01;
    color: #292929;
  }

  .btn-estado.enviado {
    background: #28a745;
  }

  .btn-estado.entregado {
    background: #005E27;
  }

  .btn-estado.detalle {
    background: #007bff;
  }

  .estado-actual {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .estado-actual.pendiente {
    background: #fff3cd;
    color: #856404;
  }

  .estado-actual.enviado {
    background: #d4edda;
    color: #155724;
  }

  .estado-actual.entregado {
    background: #d1e7dd;
    color: #0f5132;
  }

  .pago-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .pago-badge.pagado {
    background: #d4edda;
    color: #155724;
  }

  .pago-badge.no-pagado {
    background: #f8d7da;
    color: #721c24;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .modal-content {
    background-color: white;
    margin: 3% auto;
    padding: 0;
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideDown 0.4s ease;
    max-height: 90vh;
    overflow-y: auto;
  }

  @keyframes slideDown {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }

    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-header {
    background: linear-gradient(135deg, #005E27 0%, #007a35 100%);
    color: white;
    padding: 25px 35px;
    border-radius: 16px 16px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0, 94, 39, 0.2);
  }

  .modal-header h2 {
    margin: 0;
    font-size: 26px;
    font-weight: 700;
  }

  .close {
    color: white;
    font-size: 32px;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.15);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .close:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: rotate(90deg);
  }

  .modal-body {
    padding: 35px;
  }

  .pedido-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border-left: 4px solid #005E27;
  }

  .info-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .info-label {
    font-size: 12px;
    color: #6c757d;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  .info-value {
    font-size: 15px;
    color: #212529;
    font-weight: 600;
  }

  .productos-section {
    margin-top: 25px;
  }

  .section-title {
    font-size: 18px;
    font-weight: 700;
    color: #005E27;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #005E27;
  }

  .productos-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .productos-table thead {
    background: linear-gradient(135deg, #005E27 0%, #007a35 100%);
    color: white;
  }

  .productos-table th {
    padding: 14px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .productos-table tbody tr {
    background: white;
    transition: all 0.2s ease;
  }

  .productos-table tbody tr:nth-child(even) {
    background: #f8f9fa;
  }

  .productos-table tbody tr:hover {
    background: #e3f2e8;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(0, 94, 39, 0.1);
  }

  .productos-table td {
    padding: 14px 16px;
    border-bottom: 1px solid #e9ecef;
    font-size: 14px;
    color: #495057;
  }

  .cantidad-badge {
    background: #005E27;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 12px;
    display: inline-block;
  }

  .precio-cell {
    font-weight: 600;
    color: #005E27;
  }

  .total-pedido {
    background: linear-gradient(135deg, #005E27 0%, #007a35 100%);
    padding: 25px;
    border-radius: 12px;
    margin-top: 30px;
    text-align: center;
    box-shadow: 0 8px 24px rgba(0, 94, 39, 0.3);
  }

  .total-label {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.9);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }

  .total-amount {
    font-size: 36px;
    font-weight: 800;
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .alerta {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    z-index: 2000;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      transform: translateX(400px);
    }

    to {
      transform: translateX(0);
    }
  }

  .alerta.success {
    background: #28a745;
  }

  .alerta.error {
    background: #dc3545;
  }

  .confirmar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    animation: fadeIn 0.3s ease;
  }

  .confirmar-box {
    background: white;
    padding: 30px;
    border-radius: 12px;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  }

  .confirmar-box h3 {
    margin: 0 0 20px 0;
    color: #333;
  }

  .confirmar-box button {
    padding: 10px 24px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    margin: 5px;
    transition: all 0.2s ease;
  }

  .confirmar-box .btn-si {
    background: #005E27;
    color: white;
  }

  .confirmar-box .btn-si:hover {
    background: #004a1f;
  }

  .confirmar-box .btn-no {
    background: #f0f0f0;
    color: #333;
  }

  .confirmar-box .btn-no:hover {
    background: #e0e0e0;
  }

  .no-data {
    text-align: center;
    padding: 40px;
    color: #6c757d;
    font-style: italic;
  }

  .pagination {
    display: flex;
    justify-content: center;
    margin: 20px 0;
    flex-wrap: wrap;
    gap: 5px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h1>Lista de Pedidos</h1>

  <div class="stats-container">
    <div class="stat-card total">
      <h3>Total Pedidos</h3>
      <p class="numero">{{ total_pedidos }}</p>
    </div>
    <div class="stat-card pendientes">
      <h3>Pendientes</h3>
      <p class="numero">{{ pedidos_pendientes }}</p>
    </div>
    <div class="stat-card enviados">
      <h3>Enviados</h3>
      <p class="numero">{{ pedidos_enviados }}</p>
    </div>
    <div class="stat-card entregados">
      <h3>Entregados</h3>
      <p class="numero">{{ pedidos_entregados }}</p>
    </div>
  </div>

  <div class="table-container">
    <div class="filtros-rapidos">
      <h3>Filtros rápidos</h3>
      <div class="filtros-buttons">
        <a href="#" class="filtro-btn todos active" onclick="filtrar('todos'); return false;">Todos</a>
        <a href="#" class="filtro-btn pendientes" onclick="filtrar('pendiente'); return false;">Pendientes</a>
        <a href="#" class="filtro-btn enviados" onclick="filtrar('enviado'); return false;">Enviados</a>
        <a href="#" class="filtro-btn entregados" onclick="filtrar('entregado'); return false;">Entregados</a>
      </div>
      <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Buscar por ID o usuario...">
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Estado</th>
          <th>Pago</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="pedidosTable">
        {% for pedido in page_obj %}
        <tr data-estado="{{ pedido.estado|lower }}" data-id="{{ pedido.id }}"
          data-search="{{ pedido.id }} {{ pedido.usuario|lower }}">
          <td>#{{ pedido.id }}</td>
          <td>{{ pedido.usuario }}</td>
          <td><span class="estado-actual {{ pedido.estado|lower }}">{{ pedido.estado }}</span></td>
          <td>
            {% if pedido.pago %}
            <span style="color: green;">Pagado</span>
            {% else %}
            <span style="color: red;">No pagado</span>
            {% endif %}
          </td>
          <td>{{ pedido.fecha_creacion|date:"d/m/Y H:i" }}</td>
          <td>
            <button class="btn-estado pendiente" onclick="cambiarEstado('{{ pedido.id }}', 'pendiente')"
              title="Marcar como pendiente">
              <i class="fa fa-clock"></i>
            </button>
            <button class="btn-estado enviado" onclick="cambiarEstado('{{ pedido.id }}', 'enviado')"
              title="Marcar como enviado">
              <i class="fa fa-truck"></i>
            </button>
            <button class="btn-estado entregado" onclick="cambiarEstado('{{ pedido.id }}', 'entregado')"
              title="Marcar como entregado">
              <i class="fa fa-check"></i>
            </button>
            <button class="btn-estado detalle" onclick="verDetalle('{{ pedido.id }}')" title="Ver detalles">
              <i class="fa fa-eye"></i> Ver
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="no-data">No hay pedidos</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="pagination">
      {% if page_obj.has_previous %}
      <a href="?page=1">&laquo; Primera</a>
      <a href="?page={{ page_obj.previous_page_number }}">Anterior</a>
      {% endif %}

      <span class="current">
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
      </span>

      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}">Siguiente</a>
      <a href="?page={{ page_obj.paginator.num_pages }}">Última &raquo;</a>
      {% endif %}
    </div>
  </div>
</div>
<div class="modal" id="detalleModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Detalles del Pedido</h2>
      <button class="close" onclick="cerrarModal()">&times;</button>
    </div>
    <div class="modal-body" id="detalleModalBody">
      <div style="text-align: center; padding: 40px;">
        <div
          style="border: 4px solid rgba(0, 94, 39, 0.1); border-top: 4px solid #005E27; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;">
        </div>
        <p style="color: #6c757d;">Cargando detalles...</p>
      </div>
    </div>
  </div>
</div>

<div id="confirmacion" style="display: none;"></div>
<div id="alertas"></div>

{% endblock %}

{% block scripts %}
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  function mostrarAlerta(mensaje, tipo) {
    const alertaDiv = document.createElement('div');
    alertaDiv.className = `alerta ${tipo}`;
    alertaDiv.textContent = mensaje;
    document.getElementById('alertas').appendChild(alertaDiv);

    setTimeout(() => {
      alertaDiv.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(() => alertaDiv.remove(), 300);
    }, 3000);
  }

  function verDetalle(id) {
    const modal = document.getElementById('detalleModal');
    const modalBody = document.getElementById('detalleModalBody');

    modal.style.display = 'block';
    modalBody.innerHTML = `
    <div style="text-align: center; padding: 40px;">
      <div style="border: 4px solid rgba(0, 94, 39, 0.1); border-top: 4px solid #005E27; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
      <p style="color: #6c757d;">Cargando detalles...</p>
    </div>
  `;

    fetch(`/usuarios/detalle_pedido/${id}/`, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
      .then(response => response.json())
      .then(data => {
        if (!data.success) {
          modalBody.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px;">No se pudieron cargar los detalles.</p>';
          return;
        }

        const p = data.pedido;

        let html = `
  <div class="pedido-info">
    <div class="info-item">
      <span class="info-label">Usuario</span>
      <span class="info-value">${p.usuario}</span>
    </div>
    <div class="info-item">
      <span class="info-label">Email</span>
      <span class="info-value">${p.email}</span>
    </div>
    <div class="info-item">
      <span class="info-label">Teléfono</span>
      <span class="info-value">${p.telefono}</span>
    </div>
    <div class="info-item">
      <span class="info-label">Dirección</span>
      <span class="info-value">${p.direccion}</span>
    </div>
    <div class="info-item">
      <span class="info-label">Estado</span>
      <span class="info-value"><span class="estado-actual ${p.estado.toLowerCase()}">${p.estado}</span></span>
    </div>
    <div class="info-item">
  <span class="info-label">Estado de Pago</span>
  <span class="info-value">${p.pago ? '<span style="color: green; font-weight: bold;"> Pagado</span>' : '<span style="color: red; font-weight: bold;">No pagado</span>'}</span>
</div>
    <div class="info-item">
      <span class="info-label">Método de Pago</span>
      <span class="info-value">${p.metodo_pago}</span>
    </div>
    <div class="info-item">
      <span class="info-label">Fecha</span>
      <span class="info-value">${p.fecha}</span>
    </div>
  </div>
      <div class="productos-section">
        <h3 class="section-title">Productos del Pedido</h3>
        <table class="productos-table">
          <thead>
            <tr>
              <th>Producto</th>
              <th style="text-align: center;">Cantidad</th>
              <th style="text-align: right;">Precio</th>
              <th style="text-align: right;">Subtotal</th>
            </tr>
          </thead>
          <tbody>
    `;

        if (p.productos && p.productos.length > 0) {
          p.productos.forEach(prod => {
            html += `
          <tr>
            <td>${prod.nombre}</td>
            <td style="text-align: center;"><span class="cantidad-badge">${prod.cantidad}</span></td>
            <td style="text-align: right;" class="precio-cell">$${parseFloat(prod.precio).toFixed(2)}</td>
            <td style="text-align: right;" class="precio-cell">$${parseFloat(prod.subtotal).toFixed(2)}</td>
          </tr>
        `;
          });
        } else {
          html += '<tr><td colspan="4" style="text-align: center; color: #6c757d; font-style: italic; padding: 30px;">Sin productos</td></tr>';
        }

        html += `
          </tbody>
        </table>
      </div>

      <div class="total-pedido">
        <div class="total-label">Total del Pedido</div>
        <div class="total-amount">$${parseFloat(p.total).toFixed(2)}</div>
      </div>
    `;

        modalBody.innerHTML = html;
      })
      .catch(error => {
        console.error('Error:', error);
        modalBody.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px;">Ocurrió un error al cargar los detalles.</p>';
      });
  }

  function cerrarModal() {
    document.getElementById('detalleModal').style.display = 'none';
  }

  window.onclick = function (event) {
    const modal = document.getElementById('detalleModal');
    if (event.target === modal) {
      cerrarModal();
    }
  }

  function cambiarEstado(id, nuevoEstado) {
    const confirmDiv = document.getElementById('confirmacion');

    const estadosNombres = {
      'pendiente': 'Pendiente',
      'enviado': 'Enviado',
      'entregado': 'Entregado'
    };

    confirmDiv.innerHTML = `
    <div class="confirmar">
      <div class="confirmar-box">
        <h3>¿Confirmar cambio de estado?</h3>
        <p>¿Desea cambiar el estado del pedido #${id} a <strong>${estadosNombres[nuevoEstado]}</strong>?</p>
        <button class="btn-si" onclick="confirmarCambioEstado('${id}', '${nuevoEstado}')">Sí, cambiar</button>
        <button class="btn-no" onclick="cancelarCambioEstado()">Cancelar</button>
      </div>
    </div>
  `;
    confirmDiv.style.display = 'block';
  }

  function confirmarCambioEstado(id, nuevoEstado) {
    document.getElementById('confirmacion').style.display = 'none';

    fetch(`/usuarios/cambiar_estado_pedido/${id}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: JSON.stringify({ estado: nuevoEstado })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          mostrarAlerta('Estado actualizado correctamente', 'success');

          const row = document.querySelector(`tr[data-id="${id}"]`);
          if (row) {
            const estadoCell = row.querySelector('.estado-actual');
            estadoCell.className = `estado-actual ${nuevoEstado}`;
            estadoCell.textContent = nuevoEstado.charAt(0).toUpperCase() + nuevoEstado.slice(1);
            row.setAttribute('data-estado', nuevoEstado);
          }

          setTimeout(() => location.reload(), 1000);
        } else {
          mostrarAlerta('Error al cambiar el estado: ' + (data.message || 'Error desconocido'), 'error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        mostrarAlerta('Error al cambiar el estado', 'error');
      });
  }

  function cancelarCambioEstado() {
    document.getElementById('confirmacion').style.display = 'none';
  }

  function filtrar(estado) {
    const rows = document.querySelectorAll('#pedidosTable tr[data-estado]');
    const buttons = document.querySelectorAll('.filtro-btn');

    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    rows.forEach(row => {
      if (estado === 'todos') {
        row.style.display = '';
      } else {
        row.style.display = row.getAttribute('data-estado') === estado ? '' : 'none';
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('searchInput');

    if (searchInput) {
      searchInput.addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#pedidosTable tr[data-search]');

        rows.forEach(row => {
          const searchText = row.getAttribute('data-search');
          row.style.display = searchText.includes(searchTerm) ? '' : 'none';
        });
      });
    }
  });
</script>
{% endblock %}