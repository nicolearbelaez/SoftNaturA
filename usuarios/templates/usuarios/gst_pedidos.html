{% extends 'usuarios/baseU.html' %}
{% load static %}
{% csrf_token %}
{% block styles %}
<link rel="stylesheet" href="{% static 'usuarios/css/mis_pedidos-gst_pedidos-ventas.css' %}">
{% endblock %}

{% block page_id %}gst-pedidos{% endblock %}


{% block content %}


<div class="container">
  <h1>Lista de Pedidos</h1>

  <div class="stats-container">
    <div class="stat-card total">
      <h3>Total Pedidos</h3>
      <p class="numero">{{ total_pedidos }}</p>
    </div>
    <div class="stat-card pendientes">
      <h3>Pendientes</h3>
      <p class="numero">{{ pedidos_pendientes }}</p>
    </div>
    <div class="stat-card enviados">
      <h3>Enviados</h3>
      <p class="numero">{{ pedidos_enviados }}</p>
    </div>
    <div class="stat-card entregados">
      <h3>Entregados</h3>
      <p class="numero">{{ pedidos_entregados }}</p>
    </div>
  </div>

  <div class="table-container">
    <div class="filtros-rapidos">
      <h3>Filtros rápidos</h3>
      <div class="filtros-buttons">
        <a href="#" class="filtro-btn todos active" onclick="filtrar('todos'); return false;">Todos</a>
        <a href="#" class="filtro-btn pendientes" onclick="filtrar('pendiente'); return false;">Pendientes</a>
        <a href="#" class="filtro-btn enviados" onclick="filtrar('enviado'); return false;">Enviados</a>
        <a href="#" class="filtro-btn entregados" onclick="filtrar('entregado'); return false;">Entregados</a>
      </div>
      <div class="search-container">
        <input type="text" class="search-input" id="searchInput" placeholder="Buscar por ID o usuario...">
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Estado</th>
          <th>Pago</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="pedidosTable">
        {% for pedido in page_obj %}
        <tr data-estado="{{ pedido.estado|lower }}" data-id="{{ pedido.id }}"
          data-search="{{ pedido.id }} {{ pedido.usuario|lower }}">
          <td>#{{ pedido.id }}</td>
          <td>{{ pedido.usuario }}</td>
          <td><span class="estado-actual {{ pedido.estado|lower }}">{{ pedido.estado }}</span></td>
          <td>
            {% if pedido.pago %}
            <span style="color: green;">Pagado</span>
            {% else %}
            <span style="color: red;">No pagado</span>
            {% endif %}
          </td>
          <td>{{ pedido.fecha_creacion|date:"d/m/Y H:i" }}</td>
          <td>
            <!-- Solo mostrar estos 3 botones SI NO está entregado -->
            {% if pedido.estado|lower != 'entregado' %}
              <button class="btn-estado pendiente" onclick="cambiarEstado('{{ pedido.id }}', 'pendiente')"
                title="Marcar como pendiente">
                <i class="fa fa-clock"></i>
              </button>
              <button class="btn-estado enviado" onclick="cambiarEstado('{{ pedido.id }}', 'enviado')"
                title="Marcar como enviado">
                <i class="fa fa-truck"></i>
              </button>
              <button class="btn-estado entregado" onclick="cambiarEstado('{{ pedido.id }}', 'entregado')"
                title="Marcar como entregado">
                <i class="fa fa-check"></i>
              </button>
            {% endif %}
            
            <!-- El botón VER siempre se muestra -->
            <button class="btn-estado detalle" onclick="verDetalle('{{ pedido.id }}')" title="Ver detalles">
              <i class="fa fa-eye"></i> Ver
            </button>
          </td>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="no-data">No hay pedidos</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="pagination">
      {% if page_obj.has_previous %}
      <a href="?page=1">&laquo; Primera</a>
      <a href="?page={{ page_obj.previous_page_number }}">Anterior</a>
      {% endif %}

      <span class="current">
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
      </span>

      {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}">Siguiente</a>
      <a href="?page={{ page_obj.paginator.num_pages }}">Última &raquo;</a>
      {% endif %}
    </div>
  </div>
</div>
<div class="modal" id="detalleModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Detalles del Pedido</h2>
      <button class="close" onclick="cerrarModal()">&times;</button>
    </div>
    <div class="modal-body" id="detalleModalBody">
      <div style="text-align: center; padding: 40px;">
        <div
          style="border: 4px solid rgba(0, 94, 39, 0.1); border-top: 4px solid #005E27; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;">
        </div>
        <p style="color: #6c757d;">Cargando detalles...</p>
      </div>
    </div>
  </div>
</div>

<div id="confirmacion" style="display: none;"></div>
<div id="alertas"></div>

{% endblock %}

{% block scripts %}
<script src="{% static 'usuarios/js/gst_pedidos-ventas-calificaciones.js' %}"></script>
{% endblock %}