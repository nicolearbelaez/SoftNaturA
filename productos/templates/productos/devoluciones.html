{% extends 'productos/baseP.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'productos/css/estilos.css' %}" />
{% endblock %}

{% block content %}
<div class="contenedor-devoluciones">
    <h2>Mis Devoluciones</h2>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="cambiarTab('lista', event)">
            <i class="fa fa-list"></i> Mis Devoluciones
        </button>
        <button class="tab-btn" onclick="cambiarTab('nueva', event)">
            <i class="fa fa-plus-circle"></i> Solicitar Devolución
        </button>
    </div>
    <!-- TAB 1: LISTA DE DEVOLUCIONES -->
    <div id="lista" class="tab-content active">
        {% if devoluciones %}
        <ul class="lista-devoluciones">
            {% for devolucion in devoluciones %}
            <li class="devolucion-item">
                <div class="devolucion-info">
                    <strong>Devolución #{{ devolucion.id }}</strong><br>Producto: {{ devolucion.producto.nombProduc }}<br>
                    Fecha: {{ devolucion.fecha_solicitud|date:"d M Y" }}<br>
                    Motivo: {{ devolucion.motivo|truncatewords:10 }}
                </div>
                <div>
                    <span class="estado {{ devolucion.estado|lower }}">
                        {{ devolucion.estado }}
                    </span>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="no-devoluciones">
            <i class="fa fa-inbox" style="font-size: 3rem; color: #ddd;"></i>
            <p>No tienes devoluciones registradas todavía.</p>
        </div>
        {% endif %}
    </div>

    <!-- TAB 2: SOLICITAR NUEVA DEVOLUCIÓN -->
    <div id="nueva" class="tab-content">
        <form class="form-devolucion" method="POST" enctype="multipart/form-data" id="formDevolucion">
            {% csrf_token %}
            <div class="form-group">
                <label for="pedido"><i class="fa fa-shopping-bag"></i> Selecciona el pedido:</label>
                <select name="pedido_id" id="selectPedido" required onchange="cargarProductos()">
                    <option value="">-- Selecciona un pedido --</option>
                    {% for pedido in pedidos_agrupados %}
                    <option value="{{ pedido.pedido_id }}">
                        Pedido #{{ pedido.pedido_id }} - {{ pedido.fecha_pedido }} ({{ pedido.cantidad_productos }}
                        producto{% if pedido.cantidad_productos > 1 %}s{% endif %})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" id="grupoProducto" style="display: none;">
                <label for="producto"><i class="fa fa-box"></i> Selecciona el producto a devolver:</label>
                <select name="producto_id" id="selectProducto" required>
                    <option value="">-- Primero selecciona un pedido --</option>
                </select>
            </div>

            <!-- AQUI PEGAS ESTO -->
            <div class="form-group" id="grupoLote" style="display:none; margin-top:10px;">
                <label><i class="fa fa-tag"></i> Lote del producto:</label>
                <p id="textoLote" class="lote-info"></p>
            </div>

            <div class="form-group">
                <label for="motivo"><i class="fa fa-comment-dots"></i> Motivo de la devolución:</label>
                <select name="motivo" id="motivo" required>
                    <option value="">-- Selecciona un motivo --</option>
                    <option value="Fecha de vencimiento expirado">Fecha de vencimiento expirado</option>
                    <option value="Producto dañado">Producto dañado (golpeado, roto o deteriorado)</option>
                    <option value="Producto equivocado">Producto equivocado</option>
                </select>
            </div>

            <div class="form-group">
                <label><i class="fa fa-camera"></i> Fotos del producto (máximo 3):</label>

                <div class="fotos-container">
                    <div class="botones-camara">
                        <button type="button" class="btn-camara" id="btnAbrirCamara">
                            <i class="fa fa-camera"></i> Tomar Foto
                        </button>
                        <button type="button" class="btn-archivo"
                            onclick="document.getElementById('inputArchivo').click()">
                            <i class="fa fa-upload"></i> Subir desde Galería
                        </button>
                        <input type="file" id="inputArchivo" accept="image/*" style="display: none;" multiple>
                    </div>

                    <p class="contador-fotos">
                        Fotos agregadas: <strong id="contadorFotos">0</strong> / 3
                    </p>

                    <div class="foto-preview-grid" id="previewGrid">
                        <div class="foto-item empty">
                            <i class="fa fa-image"></i>
                        </div>
                        <div class="foto-item empty">
                            <i class="fa fa-image"></i>
                        </div>
                        <div class="foto-item empty">
                            <i class="fa fa-image"></i>
                        </div>
                    </div>
                </div>

                <input type="file" name="foto1" id="foto1" accept="image/*" style="display:none;">
                <input type="file" name="foto2" id="foto2" accept="image/*" style="display:none;">
                <input type="file" name="foto3" id="foto3" accept="image/*" style="display:none;">

            </div>

            <button type="submit" class="btn-submit"><i class="fa fa-paper-plane"></i> Enviar Solicitud de
                Devolución</button>
        </form>
    </div>
</div>

<!-- MODAL CÁMARA -->
<div class="modal-camara" id="modalCamara">
    <div class="modal-content-camara">
        <h3>Tomar Foto del Producto</h3>
        <div class="video-container">
            <video id="videoElement" autoplay></video>
        </div>
        <canvas id="canvasElement" class="canvas-hidden"></canvas>
        <div class="botones-modal">
            <button type="button" class="btn-capturar" id="btnCapturar">
                <i class="fa fa-camera"></i> Capturar
            </button>
            <button type="button" class="btn-cerrar-modal" id="btnCerrarModal">
                <i class="fa fa-times"></i> Cerrar
            </button>
        </div>
    </div>
</div>

<script id="productosData" type="application/json">
    {{ productos_devolubles|safe }}
</script>

{% endblock %}

{% block scripts %}
<script src="{% static 'productos/js/devoluciones.js' %}"></script>
{% endblock %}
