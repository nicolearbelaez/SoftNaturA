

{% block styles %}
<style>
    body {
        font-size: 18px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }

    .checkout-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 30px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(10px);
    }

    .checkout-container h2 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 32px;
        color: #0a7d23;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 25px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    table th, table td {
        border: none;
        padding: 16px;
        text-align: center;
        font-size: 16px;
    }

    table th {
        background: #0a7d23;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    table td {
        background: white;
        border-bottom: 1px solid #f0f0f0;
    }

    table tr:last-child td {
        border-bottom: none;
    }

    .total {
        text-align: right;
        font-size: 24px;
        margin-bottom: 20px;
        color: #2d572c;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .btn-pagar {
        display: block;
        width: 100%;
        padding: 16px;
        background: #0a7d23;
        color: white;
        text-align: center;
        font-weight: bold;
        text-decoration: none;
        border-radius: 50px;
        transition: all 0.3s ease;
        font-size: 18px;
        border: none;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(33, 136, 56, 0.3);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-pagar:hover {
        background: linear-gradient(135deg, #1e7e34, #218838);
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(33, 136, 56, 0.4);
    }

    .btn-pagar:active {
        transform: translateY(-1px);
    }

    input, select {
        padding: 12px;
        font-size: 16px;
        width: 90%;
        margin-top: 8px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    input:focus, select:focus {
        outline: none;
        border-color: #2d572c;
        box-shadow: 0 0 0 3px rgba(45, 87, 44, 0.1);
    }

    label {
        display: block;
        margin-bottom: 15px;
        text-align: left;
        color: #2d572c;
        font-weight: 600;
    }

    /* Formulario de pago mejorado */
    #formularioPago {
        background: rgba(255, 255, 255, 0.9);
        border: 3px solid #2d572c;
        border-radius: 20px;
        padding: 30px;
        margin-top: 30px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    }

    #formularioPago h3 {
        text-align: center;
        color: #2d572c;
        margin-bottom: 25px;
        font-size: 24px;
    }

    /* Estilos para calificación mejorados */
    .calificacion-form {
        max-width: 700px;
        margin: 40px auto;
        padding: 40px;
        background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
        border-radius: 25px;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.2);
        display: none;
        border: 3px solid #4a90e2;
    }

    .calificacion-form h3 {
        text-align: center;
        color: #2d572c;
        margin-bottom: 30px;
        font-size: 28px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .rating-section {
        margin-bottom: 30px;
        padding: 25px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 15px;
        border: 2px solid #e8f4fd;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .rating-section label {
        color: #2d572c;
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 15px;
        display: block;
    }

    .rating-stars {
        font-size: 2.5rem;
        text-align: center;
        margin: 20px 0;
        cursor: pointer;
    }

    .star {
        color: #ddd;
        transition: all 0.3s ease;
        margin: 0 8px;
        display: inline-block;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .star:hover {
        color: #ffd700;
        transform: scale(1.3);
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
    }

    .star.active {
        color: #ffd700;
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        animation: pulse 0.6s ease-in-out;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    .rating-display {
        text-align: center;
        margin-top: 10px;
        font-size: 16px;
        color: #666;
        font-weight: 600;
    }

    .comentario {
        margin-top: 25px;
    }

    .comentario label {
        color: #2d572c;
        font-weight: bold;
        font-size: 18px;
    }

    .comentario textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
        transition: all 0.3s ease;
    }

    .comentario textarea:focus {
        outline: none;
        border-color: #2d572c;
        box-shadow: 0 0 0 3px rgba(45, 87, 44, 0.1);
    }

    .success-message {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #0a7d23;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        margin-top: 20px;
        display: none;
        border: 2px solid #b6d7a8;
        box-shadow: 0 10px 30px rgba(21, 87, 36, 0.2);
    }

    .success-message h3 {
        margin-bottom: 15px;
        font-size: 24px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    /* Animaciones */
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .checkout-container {
            margin: 20px;
            padding: 20px;
        }
        
        .star {
            font-size: 2rem;
            margin: 0 4px;
        }
    }
</style>

<div class="checkout-container">
    <h2>📋 Resumen del pedido</h2>

    <table>
        <thead>
            <tr>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            {% for item in productos %}
            <tr>
                <td>{{ item.nombre }}</td>
                <td>${{ item.precio }}</td>
                <td>{{ item.cantidad }}</td>
                <td>${{ item.subtotal }}</td>
            </tr>
           {% endfor %}
        </tbody>
    </table>

    <p class="total"><strong> Total: ${{ total }}</strong></p>

    <!-- Botón para mostrar el formulario de pago -->
    <div style="text-align:center; margin-top: 20px;">
        <button onclick="mostrarFormulario()" class="btn-pagar"> Confirmar y pagar</button>
    </div>

    <!-- Formulario de pago oculto inicialmente -->
    <div id="formularioPago" style="display: none;" class="fade-in">
        <form onsubmit="realizarPago(event)"> 
            <h3> Formulario de pago</h3>

            <div class="form-row">
                <div class="form-group">
                    <label> Nombre completo:
                        <input type="text" id="nombreCliente" required>
                    </label>
                </div>
                <div class="form-group">
                    <label> Email:
                        <input type="email" id="emailCliente" required>
                    </label>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label> Teléfono:
                        <input type="tel" id="telefonoCliente" required>
                    </label>
                </div>
                <div class="form-group">
                    <label> Dirección:
                        <input type="text" id="direccionCliente" required>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label> Método de pago:
                    <select id="metodoPago" onchange="mostrarCamposPago()" required>
                        <option value="">-- Selecciona un método --</option>
                        <option value="nequi"> Nequi</option>
                        <option value="daviplata"> Daviplata</option>
                        <option value="bancolombia"> Bancolombia</option>
                        <option value="tarjeta">Tarjeta (MercadoPago)</option>
                    </select>
                </label>
            </div>
            <!-- Campos de MercadoPago (tarjeta) -->
            <div id="mercadoPagoCampos">
                <h3>Datos de tarjeta (MercadoPago)</h3>

                <div class="form-group" style="display: none;">
                    <label> Número de tarjeta:
                        <input type="text" id="cardNumber" data-checkout="cardNumber" >
                    </label>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Mes de expiración:
                            <input type="text" id="cardExpirationMonth" data-checkout="cardExpirationMonth" >
                        </label>
                    </div>
                    <div class="form-group">
                        <label>Año de expiración:
                            <input type="text" id="cardExpirationYear" data-checkout="cardExpirationYear" >
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>CVV:
                        <input type="text" id="securityCode" data-checkout="securityCode">
                    </label>
                </div>

                <div class="form-group">
                    <label>Nombre del titular:
                        <input type="text" id="cardholderName" data-checkout="cardholderName" >
                    </label>
                </div>

                <div class="form-group">
                    <label>Tipo de documento:
                        <input type="text" id="docType" data-checkout="docType" value="CC">
                    </label>
                </div>

                <div class="form-group">
                    <label>Número de documento:
                        <input type="text" id="docNumber" data-checkout="docNumber">
                    </label>
                </div>

                <div class="form-group">
                    <label>Cuotas:
                        <input type="number" id="installments" data-checkout="installments" value="1">
                    </label>
                </div>

                <input type="hidden" name="token" id="token">
                <input type="hidden" name="payment_method_id" id="payment_method_id">
            </div>


            <div id="campoNequi" style="display: none;">
                <label for="numeroNequi">Número de Nequi:
                    <input type="text" id="numeroNequi" name="numeroNequi" placeholder="3001234567">
                </label>
            </div>

            <div id="campoDaviplata" style="display: none;">
                <label for="numeroDaviplata">Número de Daviplata:
                    <input type="text" id="numeroDaviplata" name="numeroDaviplata" placeholder="3001234567">
                </label>
            </div>

            <div id="campoBancolombia" style="display: none;">
                <label for="numeroBancolombia">Número de cuenta Bancolombia:
                    <input type="text" id="numeroBancolombia" name="numeroBancolombia" placeholder="12345678901">
                </label>
            </div>

            <div style="text-align: center; margin-top: 25px;">
                <button type="submit" class="btn-pagar" style="width: auto; padding: 12px 40px;">
                     Procesar Pago
                </button>
            </div>

            <p id="mensajePago" style="margin-top: 15px; color: green; font-weight: bold; text-align: center;"></p>
        </form>
    </div>

    <!-- Mensaje de éxito -->
    <div id="pagoExitoso" class="success-message">
        <h3> ¡Pago realizado con éxito!</h3>
        <p>Tu pedido ha sido procesado correctamente.</p>
        <p> ¿Cómo te fue con nuestro servicio? ¡Déjanos tu calificación y cuéntanos tu experiencia!</p>
        <button onclick="mostrarCalificacion()" class="btn-pagar" style="width: auto; margin-top: 20px; padding: 12px 30px;">
        Calificar mi experiencia
        </button>
    </div>
</div>

<!-- Formulario de calificación mejorado -->
<div class="calificacion-form fade-in" id="formularioCalificacion">
    <h3> Califica tu experiencia de compra</h3>
    
    
    <!-- Formulario de calificación -->
<form method="POST" action="{% url 'productos:guardar_calificacion' %}">
    {% csrf_token %}

    <div class="rating-section">
        <label> Calificación del servicio:</label>
        <div class="rating-stars" data-rating="0" data-type="servicio">
            {% for i in "12345" %}
                <span class="star" data-value="{{ i }}">★</span>
            {% endfor %}
        </div>
        <div class="rating-display" id="servicioDisplay">Selecciona una calificación</div>
        <input type="hidden" name="puntuacion_servicio" id="puntuacionServicio" required>
    </div>

    <div class="rating-section">
        <label>Calificación de los productos:</label>
        <div class="rating-stars" data-rating="0" data-type="productos">
            {% for i in "12345" %}
                <span class="star" data-value="{{ i }}">★</span>
            {% endfor %}
        </div>
        <div class="rating-display" id="productosDisplay">Selecciona una calificación</div>
        <input type="hidden" name="puntuacion_productos" id="puntuacionProductos" required>
    </div>

    <div class="comentario">
        <label for="comentario">💬 Cuéntanos tu experiencia:</label>
        <textarea id="comentario" name="comentario" placeholder="Comparte tu opinión sobre nuestro servicio y productos..." required></textarea>
    </div>

    <!-- ID del servicio fijo (puedes cambiar el 1 por el ID real que tengas) -->
    <input type="hidden" name="servicio_id" value="1">

    <div style="text-align: center; margin-top: 30px;">
        <button type="submit" class="btn-pagar" style="width: auto; padding: 15px 40px;">
            Enviar Calificación
        </button>
    </div>
</form>

</div>

<script>
    const ratingTexts = {
        1: 'Muy malo',
        2: 'Malo', 
        3: 'Regular',
        4: 'Bueno',
        5: 'Excelente'
    };

    function mostrarFormulario() {
        const formulario = document.getElementById('formularioPago');
        formulario.style.display = 'block';
        formulario.classList.add('fade-in');
        
        // Scroll suave hacia el formulario
        formulario.scrollIntoView({ behavior: 'smooth' });
    }

    function mostrarCamposPago() {
        const metodo = document.getElementById("metodoPago").value;

        // Oculta todos
        document.getElementById("campoNequi").style.display = "none";
        document.getElementById("campoDaviplata").style.display = "none";
        document.getElementById("campoBancolombia").style.display = "none";
        document.getElementById("mercadoPagoCampos").style.display = "none";

        // Limpia campos
        document.getElementById("numeroNequi").value = "";
        document.getElementById("numeroDaviplata").value = "";
        document.getElementById("numeroBancolombia").value = "";

        // Muestra el campo adecuado con animación
        if (metodo === "nequi") {
            const campo = document.getElementById("campoNequi");
            campo.style.display = "block";
            campo.classList.add('fade-in');
        } else if (metodo === "daviplata") {
            const campo = document.getElementById("campoDaviplata");
            campo.style.display = "block";
            campo.classList.add('fade-in');
        } else if (metodo === "bancolombia") {
            const campo = document.getElementById("campoBancolombia");
            campo.style.display = "block";
            campo.classList.add('fade-in');
        } else if (metodo === "tarjeta") {
            const campo = document.getElementById("mercadoPagoCampos");
            campo.style.display = "block";
            campo.classList.add('fade-in');
        }
    }

    function realizarPago(event) {
        event.preventDefault();
        
        // Simular proceso de pago
        const boton = event.target.querySelector('button[type="submit"]');
        const textoOriginal = boton.innerHTML;
        
        boton.disabled = true;
        
        document.getElementById("mensajePago").innerHTML = "Procesando pago...";
        
        setTimeout(() => {
            document.getElementById("mensajePago").innerHTML = "¡Pago realizado con éxito!";
            
            setTimeout(() => {
                document.getElementById("formularioPago").style.display = "none";
                const pagoExitoso = document.getElementById("pagoExitoso");
                pagoExitoso.style.display = "block";
                pagoExitoso.classList.add('fade-in');
                pagoExitoso.scrollIntoView({ behavior: 'smooth' });
            }, 1500);
        }, 2000);
    }

    function mostrarCalificacion() {
        document.getElementById("pagoExitoso").style.display = "none";
        const formulario = document.getElementById("formularioCalificacion");
        formulario.style.display = "block";
        formulario.classList.add('fade-in');
        
        // Scroll suave hacia el formulario de calificación
        formulario.scrollIntoView({ behavior: 'smooth' });
    }

    // Sistema de calificación con estrellas mejorado
    document.addEventListener('DOMContentLoaded', function() {
        const ratingContainers = document.querySelectorAll('.rating-stars');
        
        ratingContainers.forEach(container => {
            const stars = container.querySelectorAll('.star');
            const type = container.dataset.type;
            
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.value);
                    const inputId = type === 'servicio' ? 'puntuacionServicio' : 'puntuacionProductos';
                    const displayId = type === 'servicio' ? 'servicioDisplay' : 'productosDisplay';
                    
                    document.getElementById(inputId).value = rating;
                    container.dataset.rating = rating;
                    updateStars(container, rating);
                    
                    // Actualizar texto descriptivo
                    document.getElementById(displayId).textContent = `${rating}/5 - ${ratingTexts[rating]}`;
                });
                
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.value);
                    updateStars(container, rating);
                });
            });
            
            container.addEventListener('mouseleave', function() {
                const currentRating = parseInt(container.dataset.rating) || 0;
                updateStars(container, currentRating);
            });
        });
        
        function updateStars(container, rating) {
            const stars = container.querySelectorAll('.star');
            stars.forEach((star, index) => {
                star.classList.toggle('active', index < rating);
            });
        }
    });

    // Validación del formulario de calificación
    document.querySelector('#formularioCalificacion form').addEventListener('submit', function(e) {
        const servicioRating = document.getElementById('puntuacionServicio').value;
        const productosRating = document.getElementById('puntuacionProductos').value;
        
        if (!servicioRating || !productosRating) {
            e.preventDefault();
            alert('Por favor, califica tanto el servicio como los productos antes de enviar.');
            return false;
        }
        
        // Confirmación antes de enviar
        if (!confirm('¿Estás seguro de enviar esta calificación?')) {
            e.preventDefault();
            return false;
        }
        
        // Mostrar mensaje de envío
        const boton = this.querySelector('button[type="submit"]');
        boton.innerHTML = 'Enviando...';
        boton.disabled = true;
    });
</script>

{% endblock %}